

### imgdose - 画像管理システム要件定義書

### 1. プロジェクト概要

本プロジェクトは、Cloudflare R2を画像ストレージとし、Cloudflare Pages/Workers および Next.js を利用して、画像のアップロード・管理機能を提供するフルスタックアプリケーション「imgdose」を開発する。データベースにはCloudflare D1を使用し、GitHubでコードを管理する。

### 2. ゴール

*   Cloudflare R2への画像の安全かつ効率的なアップロード機能の実現。
*   アップロードされた画像の容易な管理（表示、検索、ソート、ダウンロード、削除）。
*   アップロードされた画像のURLを容易に取得し、外部サービス（ブログなど）での利用を促進する。
*   使いやすい管理画面の提供。
*   スケーラブルでパフォーマンスの高いインフラストラクチャの構築。

### 3. システム構成

*   **フロントエンド:** Next.js (Pages)
*   **バックエンド:** Cloudflare Workers (APIエンドポイント)
*   **画像ストレージ:** Cloudflare R2 (バケット名: `imgdose`)
    *   **重要:** R2バケット内はフォルダ階層を持たず、全ての画像はフラットに保存される。
*   **データベース:** Cloudflare D1
*   **コード管理:** GitHub (リポジトリ/プロジェクト名: `imgdose`)

### 4. 機能要件

#### 4.1. 認証・認可

*   管理画面へのアクセスにはBasic認証（ID/パスワード）が必要。簡素なものでOK。

#### 4.2. 画像アップロード機能

*   **単一画像アップロード:**
    *   管理画面から1枚の画像を選択してアップロードできる。
    *   ファイル形式のバリデーション（例: JPEG, PNG, WebPなど）。
    *   ファイルサイズの上限設定。
*   **複数画像アップロード:**
    *   管理画面から複数の画像を一度に選択してアップロードできる。
    *   ドラッグ＆ドロップによるアップロードにも対応。
*   **アップロード時のメタデータ:**
    *   アップロード日時は自動的に記録される。
    *   ユーザーが任意で追加するメタデータは不要。
*   **R2ストレージへの保存:**
    *   R2バケット内はフォルダ階層を持たず、全ての画像はフラットに保存される。

#### 4.3. 画像管理画面機能

*   **画像一覧表示:**
    *   D1データベースに紐づく画像の情報（D1のユニークID、画像名、URL、アップロード日、ファイルサイズ）を一覧で表示。
    *   表示形式は以下の2種類をトグルで切り替え可能。
        *   **テーブル表示:**
            *   画像名、URL、アップロード日、ファイルサイズなどのカラムを表示。
        *   **ギャラリー表示:**
            *   画像のサムネイルをタイル形式で表示。クリック時の動作は後述。
    *   UI/UXは提示のイメージ画像に準拠し、簡素で安定稼働を重視する。
*   **ソート機能:**
    *   アップロード日（昇順/降順）、画像名（昇順/降順）、ファイルサイズ（昇順/降順）でソート可能。
*   **簡易検索機能:**
    *   画像名の一部または完全に一致する画像を検索可能。
    *   タグ検索や期間指定検索は不要。
*   **選択機能:**
    *   一覧表示されている画像から複数選択できる。
*   **ダウンロード機能:**
    *   選択した画像を個別にダウンロードできる。
    *   **複数選択した画像をまとめてZIPファイルでダウンロード:** 可能であれば実装（優先度: 中）。
*   **削除機能:**
    *   選択した画像をR2ストレージおよびD1データベースから削除できる。
    *   削除時には確認ダイアログを表示する。
*   **URLコピー機能 (重要):**
    *   ギャラリー表示またはテーブル表示において、画像を（クリックまたは特定のアイコン操作で）選択した際に、その画像のR2が提供する直接URLがクリップボードにコピーされる機能。
    *   このURLはブログなどのマークダウン形式で直接利用できることを想定。

### 5. 非機能要件

#### 5.1. 性能

*   大量の画像が保存されても、管理画面の表示や検索が高速に行われること。
*   画像のアップロード・ダウンロードがスムーズに行われること。

#### 5.2. セキュリティ

*   管理画面への不正アクセス防止（Basic認証による）。
*   R2への直接アクセスを制限し、Workers経由でのアクセスのみ許可する。
*   D1へのアクセスもWorkers経由に限定し、SQLインジェクション対策を施す。

#### 5.3. 信頼性

*   システムが安定稼働し、画像の損失が発生しないこと。

#### 5.4. 拡張性

*   D1データベースのユニークIDをコアに、将来的にタグやカテゴリなどを拡張できるようなDB設計とする。
*   フロントエンドでのデータ読み書き・出し入れを想定した設計。

#### 5.5. 運用・保守性

*   エラーログの取得、監視が容易であること。
*   Cloudflareの提供する各種ツールを活用し、運用負荷を軽減する。

### 6. 技術スタック

*   **フロントエンド:** Next.js (React, TypeScript, CSS Framework: Tailwind CSS or Chakra UI など - お任せ)
*   **バックエンド:** Cloudflare Workers (JavaScript/TypeScript)
*   **データベース:** Cloudflare D1 (SQLite)
    *   DBのユニークIDを画像本体および関連情報の管理の基軸とする。
*   **ストレージ:** Cloudflare R2
    *   バケット内はフォルダ階層なし（フラット構造）。
*   **バージョン管理:** Git / GitHub

---

